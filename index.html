<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSI Model Simulation</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
<header>
    <h1>OSI Model Simulation</h1>
</header>

<main>
    <form id="simulation-form">
        <label for="input-data">Data to send:</label>
        <input type="text" id="input-data" required>
        <button type="submit">Simulate</button>
    </form>

    <div id="loader" class="loader hidden"></div> <!-- Add the loader element here -->

    <section id="results" class="hidden">
        <h2>Simulation Results</h2>
        <div class="result-label">Original data:</div>
        <div id="original-data"></div>

        <button id="toggle-transmitted-data" class="hidden">Toggle Transmitted Data</button>
        <div class="result-label">Transmitted data:</div>
        <table id="transmitted-data" class="hidden">
            <thead>
            <tr>
                <th>Frame</th>
                <th>Header</th>
                <th>Payload</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <div class="result-label">Received data:</div>
        <div id="received-data"></div>
        <!-- Add this inside the "results" section -->
        <div class="result-label">Log:</div>
        <textarea id="log-messages" readonly rows="10"></textarea>

    </section>


</main>
<script>
    const simulationForm = document.getElementById('simulation-form');
    const inputDataField = document.getElementById('input-data');
    const submitButton = simulationForm.querySelector('button[type="submit"]');
    const loader = document.getElementById('loader');

    simulationForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        submitButton.disabled = true;
        // Disable input and submit button, and show the loader
        document.getElementById('input-data').disabled = true;
        submitButton.disabled = true;
        submitButton.classList.add('submit-loading');
        loader.classList.remove('hidden');

        const inputData = inputDataField.value;
        const response = await fetch('index.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dataPacket: inputData }) // Send the data packet instead of raw inputData
        });

        // Enable input and submit button, and hide the loader
        document.getElementById('input-data').disabled = false;
        submitButton.disabled = false;
        submitButton.classList.remove('submit-loading');
        loader.classList.add('hidden');


        if (response.ok) {
            const result = await response.json();
            document.getElementById('original-data').textContent = result.originalData;

            // Update table with transmitted frames
            const tableBody = document.getElementById('transmitted-data').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            result.transmittedData.forEach((frame, index) => {
                const row = tableBody.insertRow(-1);
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);
                const cell3 = row.insertCell(2);

                cell1.textContent = index + 1;
                cell2.textContent = JSON.stringify(frame.frame_header);
                cell3.textContent = frame.payload;
            });

            document.getElementById('received-data').textContent = result.receivedData;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('toggle-transmitted-data').classList.remove('hidden');
        } else {
            const errorText = await response.text();
            alert('An error occurred while processing the simulation. ' + errorText);
        }
    });

    document.getElementById('toggle-transmitted-data').addEventListener('click', () => {
        const table = document.getElementById('transmitted-data');
        table.classList.toggle('hidden');
    });
</script>
</body>
</html>
